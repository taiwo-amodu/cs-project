<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emergency Services Navigation</title>
  
  <!-- Mapbox CSS & JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <!-- Mapbox Geocoder -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" />

  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 100vh; }
    
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      width: 250px;
    }
    
    select, button {
      width: 100%;
      margin-top: 5px;
      padding: 8px;
      font-size: 14px;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>

  <!-- Controls -->
  <div class="controls">
    <button onclick="getUserLocation()">Find My Location</button>
    <select id="serviceList">
      <option value="">Select a Service</option>
    </select>
    <button onclick="routeToService()">Navigate to Service</button>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoidGF5ZWVlZSIsImEiOiJjbTZuZXc3NmEwdWd4MmxzbWZnNm42Mnl4In0.w--ev1D5hZU_IGSvHqnJow';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-9.1393, 38.7223], // Default center (Lisbon)
      zoom: 12
    });

    let userMarker, routeLayer, allMarkers = [];
    let servicesData = [];
    let userLocation = null;

    // Fetch and display all emergency services
    function loadAllServices() {
      fetch('/api/services')
        .then(response => response.json())
        .then(data => {
          if (!data.length) {
            alert("No emergency services found!");
            return;
          }
          
          servicesData = data;
          const serviceList = document.getElementById("serviceList");

          data.forEach(service => {
            const lon = service.longitude;
            const lat = service.latitude;

            // Add service markers to the map
            const marker = new mapboxgl.Marker({ color: 'red' })
              .setLngLat([lon, lat])
              .setPopup(new mapboxgl.Popup().setHTML(`
                <h3>${service.name}</h3>
                <p>Type: ${service.type}</p>
                <p>Address: ${service.address || 'N/A'}</p>
                <p>Contact: ${service.contact_info || 'N/A'}</p>
              `))
              .addTo(map);

            allMarkers.push(marker);

            // Add service to dropdown list
            let option = document.createElement("option");
            option.value = service.id;
            option.textContent = `${service.name} - ${service.type}`;
            serviceList.appendChild(option);
          });
        })
        .catch(error => console.error("Error loading services:", error));
    }

    // Get user location
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true });
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    function success(position) {
      const userLon = position.coords.longitude;
      const userLat = position.coords.latitude;
      userLocation = { lon: userLon, lat: userLat };

      if (userMarker) userMarker.remove();
      userMarker = new mapboxgl.Marker({ color: 'blue' })
        .setLngLat([userLon, userLat])
        .setPopup(new mapboxgl.Popup().setHTML("<h3>You are here</h3>"))
        .addTo(map);

      map.flyTo({ center: [userLon, userLat], zoom: 14 });
    }

    function error() {
      alert("Unable to retrieve your location.");
    }

    // Route from user location to selected emergency service
    function routeToService() {
      const selectedServiceId = document.getElementById("serviceList").value;

      if (!selectedServiceId) {
        alert("Please select a service to navigate to.");
        return;
      }

      if (!userLocation) {
        alert("Please allow location access and try again.");
        return;
      }

      const service = servicesData.find(s => s.id == selectedServiceId);
      if (!service) {
        alert("Invalid service selected.");
        return;
      }

      fetch(`/api/route?start_lon=${userLocation.lon}&start_lat=${userLocation.lat}&end_lon=${service.longitude}&end_lat=${service.latitude}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert("No route found!");
            return;
          }

          drawRoute(data.geometry);
        })
        .catch(error => console.error("Error fetching route:", error));
    }

    // Draw route on Mapbox
    function drawRoute(routeGeometry) {
      if (routeLayer) map.removeLayer('route');
      if (map.getSource('route')) map.removeSource('route');

      map.addSource('route', {
        'type': 'geojson',
        'data': {
          'type': 'Feature',
          'properties': {},
          'geometry': {
            'type': 'LineString',
            'coordinates': decodePolyline(routeGeometry)
          }
        }
      });

      routeLayer = map.addLayer({
        'id': 'route',
        'type': 'line',
        'source': 'route',
        'layout': {
          'line-join': 'round',
          'line-cap': 'round'
        },
        'paint': {
          'line-color': '#ff0000',
          'line-width': 4
        }
      });
    }

    // Decode OSRM polyline geometry
    function decodePolyline(str) {
      let index = 0, lat = 0, lng = 0, coordinates = [];
      while (index < str.length) {
        let shift = 0, result = 0, byte;
        do {
          byte = str.charCodeAt(index++) - 63;
          result |= (byte & 0x1F) << shift;
          shift += 5;
        } while (byte >= 0x20);
        lat += ((result & 1) ? ~(result >> 1) : (result >> 1));
        shift = 0;
        result = 0;
        do {
          byte = str.charCodeAt(index++) - 63;
          result |= (byte & 0x1F) << shift;
          shift += 5;
        } while (byte >= 0x20);
        lng += ((result & 1) ? ~(result >> 1) : (result >> 1));
        coordinates.push([lng / 1e5, lat / 1e5]);
      }
      return coordinates;
    }

    loadAllServices();
  </script>

</body>
</html>


